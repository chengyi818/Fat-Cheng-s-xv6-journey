# LEC_13: 崩溃恢复, 日志

## 大纲
1. 崩溃将会导致磁盘文件系统的内容前后矛盾.比如bitmap标记某block为free,但仍有inode指向该block等...
2. 解决方案: 引入日志.

## 崩溃恢复

### 什么是崩溃恢复?
1. 当你正在写文件时,电脑突然断电.电脑重启后,是否文件系统是否还能正常工作?

### 崩溃带来的问题
1. 执行文件操作时,异常断电可能导致文件系统出现问题.
2. 可能导致文件系统再次发生崩溃,更糟糕的情况是没有崩溃,但是读写文件不正常.

### 栗子
1. 创建文件时,分配了`dirent`和相关的inode,但是没有将inode标记为used.
2. 创建文件时,分配了`dirent`和相关的inode,但是没有将标记为used的inode保存到`dirent`中.
3. 写文件时,为inode分配了新的block,但没有更新bitmap中的标记位.
4. 写文件时,更新了bitmap中的标记位,但没有更新inode中addrs.
5. 不一而足,一个文件系统操作往往需要多个步骤,因此我们需要将多个操作整合为一个原子操作.

### 我们的目标
1. 计算机重启后,执行文件系统恢复模式.
2. 文件系统本身不会产生矛盾,比如一个block在bitmap中标识为free,却又存在于一个file对应的inode中.
3. 除了崩溃发生时的一小部分数据,其他所有数据都能正常地持久化保存在磁盘上.
4. 文件操作不会产生乱序.

### 性能和存储安全之间的权衡
1. 性能和存储安全之间往往都是矛盾的.
2. 磁盘读写速度相对于内存而言非常慢.
3. 如果为了存储安全,我们需要将数据立刻写回磁盘.
4. 如果为了性能,那么我们可以做各种优化,推迟写回磁盘的时间.比如批量写回, 写入缓存buffer, 按磁盘轨道排序...

### 崩溃恢复是一个历史悠久的问题
1. 所有持久化存储系统都会面临这个问题,比如数据库.
2. 目前已经有很多成熟的解决方案.
3. 这些解决方案都是在正确性和性能之间取得尽可能的平衡和妥协.

---

## 解决方案: 日志
